version: '3.8'

# 仅保留一个 services 节点，包含所有服务配置
services:
  backend:
    #build:
      #context: .
      #dockerfile: src/Dockerfile.backend
    image: fastapi-backend:v1 # 使用预构建镜像，避免每次都构建  
    container_name: ollama-backend
    ports:
      - "8000:8000"
    volumes:
      - ./rag_data:/app/data  # 知识库数据持久化
    environment:
      - PYTHONUNBUFFERED=1
      - OLLAMA_HOST=http://ollama-server:11434  # 关联 Ollama 服务
      - QDRANT_HOST=qdrant-server
      - QDRANT_PORT=6333
    restart: unless-stopped
    networks:
      - app-network

  # 新增 Ollama 服务（若项目依赖本地 Ollama 实例）
  ollama-server:
    image: ollama/ollama:latest
    container_name: ollama
    ports:
      - "11434:11434"
    volumes:
      - ./ollama_data:/root/.ollama  # 模型数据持久化
    restart: unless-stopped
    networks:
      - app-network

  # 新增 Qdrant 向量数据库服务
  qdrant-server:
    image: qdrant/qdrant:latest
    container_name: qdrant
    ports:
      - "6333:6333"
    volumes:
      - ./qdrant_data:/qdrant/storage  # 向量数据持久化
    restart: unless-stopped
    networks:
      - app-network

# 网络配置（仅需定义一次）
networks:
  app-network:
    driver: bridge