version: '3.8'

services:
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile.backend
    #image: fastapi-backend:v1
    #container_name: fastapi-backend  # 修正：原是ollama-backend，改为fastapi-backend
    ports:
      - "8000:8000"
    volumes:
      - ./rag_data:/app/data
    environment:
      - PYTHONUNBUFFERED=1
      - OLLAMA_HOST=http://ollama-server:11434  # 正确：指向Ollama服务名
      - QDRANT_HOST=qdrant-server
      - QDRANT_PORT=6333
    restart: unless-stopped
    networks:
      - app-network
    depends_on:
      - ollama-server  # 关键：让FastAPI在Ollama启动后再启动
      - qdrant-server

  ollama-server:
    image: ollama/ollama:latest
    container_name: ollama-server  # 修正：原是ollama，改为ollama-server（与服务名一致）
    ports:
      - "11434:11434"
    volumes:
      - ./ollama_data:/root/.ollama
    restart: unless-stopped
    networks:
      - app-network
    # 可选：启动时自动拉取模型（比如llama3），避免手动操作
    
    #command: ["run", "llama3"]

  qdrant-server:
    image: qdrant/qdrant:latest
    container_name: qdrant-server  # 修正：原是qdrant，改为qdrant-server（与服务名一致）
    ports:
      - "6333:6333"
    volumes:
      - ./qdrant_data:/qdrant/storage
    restart: unless-stopped
    networks:
      - app-network

networks:
  app-network:
    driver: bridge